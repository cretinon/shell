version: 2.1

commands:
  circleci-image-update:
    description: 'update apt repo'
    steps:
      - run:
          name: circleci image update
          command: sudo mkdir -p /var/lib/apt/lists/partial ; sudo chmod 755 /var/lib/apt/lists/ ; echo "sudo rm -rf /etc/apt/sources.list.d/github_git-lfs.list"; sudo apt update

  install-bats:
    description: 'install bats from apt'
    steps:
      - run:
          name: Install bats
          command: sudo apt install -y bats bats-assert bats-file bats-support

  install-shellcheck:
    description: 'install shellcheck from apt'
    steps:
      - run:
          name: Install shellcheck
          command: sudo apt install -y shellcheck

  install-kcov:
    description: 'install kcov manually'
    steps:
      - run:
          name: Install kcov
          command: cd /tmp ; wget http://archive.ubuntu.com/ubuntu/pool/universe/k/kcov/kcov_43+dfsg-2_amd64.deb ; sudo dpkg -i kcov_43+dfsg-2_amd64.deb

  install-nmap:
    description: 'install nmap & dig from apt'
    steps:
      - run:
          name: Install nmap
          command: sudo apt install -y nmap bind9-dnsutils

  install-codecov:
    description: 'install pip && pipx from apt then codecov from pipx'
    steps:
      - run:
          name: Install pip
          command: sudo apt install -y pip pipx
      - run:
          name: Install codecov
          command: pipx install codecov-cli

  install-iptables:
    description: 'install iptables'
    steps:
      - run:
          name: Install iptables
          command: sudo apt install -y iptables

  install-keepassxc:
    description: 'install keepassxc'
    steps:
      - run:
          name: Install keepassxc
          command: sudo apt install -y keepassxc

  checkout-prereq:
    description: 'mkdir'
    steps:
      - run:
          name : mkdir destination directory for git checkout
          command: mkdir -p git/shell

  prepare-our-environment:
    description: 'set all prereq for my_warp'
    steps:
      - run:
          name: set all prereq for my_warp
          command: chmod +x ${HOME}/project/git/shell/my_warp.sh ; mkdir ${HOME}/conf ; echo -e "VERBOSE=false\nDEBUG=false\nYUBIKEY=false\nFUNC_LIST=()\nMY_GIT_DIR=\"\${HOME}/project/git\"" > ${HOME}/conf/my_warp.conf

  circleci-image-result:
    description: 'results of previous build steps'
    steps:
      - run:
          name : Results of previous build steps
          command: type bats ; bats --version ; type shellcheck ; shellcheck --version ; type kcov ; kcov --version ; type yq ; yq --version ; echo -n "pwd:"; pwd ; find . ; echo "my_warp.conf" ; cat ${HOME}/conf/my_warp.conf

  run-shellcheck:
    description: 'run shellcheck'
    steps:
      - run:
          name: Run shellcheck
          command: cd "${HOME}/project/git/shell" && MY_GIT_DIR="${HOME}/project/git" ${HOME}/project/git/shell/my_warp.sh --lib shell -s

  run-bats:
    description: 'run bats'
    steps:
      - run:
          name: Run bats
          command: cd "${HOME}/project/git/shell" && MY_GIT_DIR="${HOME}/project/git" ${HOME}/project/git/shell/my_warp.sh --lib shell -b

  run-kcov:
    description: 'run kcov'
    steps:
      - run:
          name: Run kcov
          command: cd "${HOME}/project/git/shell" && MY_GIT_DIR="${HOME}/project/git" ${HOME}/project/git/shell/my_warp.sh -d -v --lib shell -k

jobs:
  build-and-test:
    docker:
      - image: cimg/base:current
    steps:
      - circleci-image-update
      - install-bats
      - install-shellcheck
      - install-kcov
      - install-nmap
      - install-codecov
      - install-iptables
      - install-keepassxc
      - checkout-prereq
      - checkout:
          path: git/shell
      - prepare-our-environment
      - circleci-image-result
      - run-shellcheck
      - run-bats
      - run-kcov

workflows:
  test-libshell:
     jobs:
       - build-and-test
