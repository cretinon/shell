version: 2.1

commands:
  circleci-image-update:
    description: 'update apt repo'
    steps:
      - run:
          name: circleci image update
          command: sudo mkdir -p /var/lib/apt/lists/partial ; sudo chmod 755 /var/lib/apt/lists/ ; sudo rm -rf /etc/apt/sources.list.d/github_git-lfs.list; sudo apt update

  install-bats:
    description: 'install bats from apt'
    steps:
      - run:
          name: Install bats
          command: sudo apt install -y bats

  install-shellcheck:
    description: 'install shellcheck from apt'
    steps:
      - run:
          name: Install shellcheck
          command: sudo apt install -y shellcheck

  checkout-prereq:
    description: 'mkdir'
    steps:
      - run:
          name : mkdir destination directory for git checkout
          command: mkdir -p git/shell

  circleci-image-result:
    description: 'results of previous build steps'
    steps:
      - run:
          name : Results of previous build steps
          command: type bats ; bats --version ; type shellcheck ; shellcheck --version ; echo -n "pwd:"; pwd ; find .

  run-shellcheck:
    description: 'run shellcheck'
    steps:
      - run:
          name: Run shellcheck
          command: shellcheck git/shell/lib_shell.sh git/shell/my_warp.sh

  run-bats:
    description: 'run bats'
    steps:
      - run:
          name: Run bats
          command: GIT_DIR="${HOME}/project/git" bats --verbose-run git/shell/bats/tests.bats

  test-func-in-circleci:
    description: 'test func call in circleci'
    steps:
      - run:
          name: Test func call in circleci
          command: chmod +x ${HOME}/project/git/shell/my_warp.sh ; mkdir ${HOME}/conf ; echo -e "VERBOSE=false\nDEBUG=false\nFUNC_LIST=()\nGIT_DIR=\"\${HOME}/project/git\"" > ${HOME}/conf/my_warp.conf ; ${HOME}/project/git/shell/my_warp.sh --lib shell hello_world ; source ${HOME}/conf/my_warp.conf ; source ${HOME}/project/git/shell/lib_shell.sh ; _os_arch

jobs:
  build-and-test:
    docker:
      - image: cimg/base:current
    steps:
      - circleci-image-update
      - install-bats
      - install-shellcheck
      - checkout-prereq
      - checkout:
          path: git/shell
      - circleci-image-result
      - run-shellcheck
      - run-bats
      - test-func-in-circleci

workflows:
  test-libshell:
     jobs:
       - build-and-test
